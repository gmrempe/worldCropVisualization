<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#000000" />

        <!-- <link rel="stylesheet" type="text/css" href="app.css" /> -->

        <title>World Crop Production Visualization</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>

    </head>

    <style>
        @import url("https://fonts.googleapis.com/css?family=Montserrat");

        body {
            font-family: "Montserrat", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        div.tooltip {	
            position: absolute;			
            text-align: center;
            align-items: center;		
            min-width: 70px;					
            height: auto;					
            padding: 2px;				
            font: 12px sans-serif;		
            background: #fff;	
            border: 1px solid #000;		
            border-radius:5px;			
            pointer-events: none;			
        }

    </style>

    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div className="App">
            <header className="App-header" style="font-size: 35px; margin-left: 3%; margin-bottom: 25px;">
                World Crop Production in Tonnes
            </header>

            <h1 style="font-size: 20px; margin-left: 3%;">Click on wedge to zoom in, Center to zoom out</h1>
            <label for='year' style="margin-left: 3%;">Select Year </label>
            
            <select className="year" id='year' onChange="draw()" style='margin-bottom: 10px;'>
                    <option value="2017" selected>2017</option>
                    <option value="2010">2010</option>
                    <option value="2000">2000</option>
                    <option value="1990">1990</option>
                    <option value="1980">1980</option>
                    <option value="1970">1970</option>
                    <option value="1961">1961</option>
            </select>
            </br>
            <a style="font-size: 12px; margin-left: 3%;" href="http://www.fao.org/faostat/en/#data/QC">Data from FAOSTAT</a>

        </div>

        <div id="chart" style="width: 100%; height: auto;">
            <svg style="font-size: 10px;"></svg>
        </div>

    </body>

    <script>
        function draw() {
        d3.selectAll('svg > *').remove();

        const year = document.getElementById('year').selectedOptions[0].value;
        const chartDiv = document.getElementById('chart');
        const width = chartDiv.clientWidth;
        const height = chartDiv.clientWidth;
        const radius = (width / 2);
        const x = d3.scaleLinear().range([0, 2 * Math.PI]);  //radians
        const y = d3.scalePow().range([0, radius]).exponent(0.8);
        let treeData = {};

        let div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        //grab data
        d3.json("/FAOSTATData.json").then(function (data) {
            d3.selectAll('svg > *').remove();

            for(let i = 0; i < data.length; i++) {
                if(data[i].year === year) {
                    treeData = data[i];
                }
            }
            
            const color = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, treeData.children.length)); 

            //place chart in center of svg element
            let svg = d3.select('svg')
                .attr("viewBox", [0,0,width,width])
              .append('g')
                .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');
             
            //give every node a value and sort
            const root = d3.hierarchy(treeData)
                .sum(function(d) { return d.value})
                .sort((a, b) => b.value - a.value)
                
            //calculate radians then add x0, y0, x1, y1 onto each node
            const partitionLayout = d3.partition()
                // .size([2 * Math.PI, radius]);  do this on line 94
            
            partitionLayout(root);
                
            const arc = d3.arc()
                .startAngle( d => Math.max(0, Math.min(2 * Math.PI, x(d.x0))))
                .endAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x1))))
                .innerRadius(d => Math.max(0, y(d.y0)))
                .outerRadius(d => Math.max(0, y(d.y1)));

            //make every node a g element
            let g = svg.selectAll('g')
                .data(root.descendants())
              .enter().append('g')
                // .attr("class", "node")  //for text
            let path = g.append('path')
                .attr("d", arc)
                .style('stroke', '#fff')
                .style("fill", function (d) { 
                    if(!d.parent) {
                        return 'white'
                    } else {
                        return color((d.children ? d : d.parent).data[Object.keys(d.data)[0]])}
                    })

              let labels = g.append("text")
                    .attr("transform", function (d) {
                        return "translate(" + arc.centroid(d) + ")rotate(" + computeTextRotation(d) + ")";
                    })
                    .attr("dx", "-20")
                    .attr("text-anchor", "middle")
                    .attr("dy", ".35em")
                    .text(function (d) { 
                        let text = d.data[Object.keys(d.data)[0]];
                        if (d.x1 - d.x0 > 0.007) {
                            return d.parent ? text : '';
                        }
                        // return d.parent ? text.attr("opacity", 0) : '';
                })

              path.on("click", function (d) {       //zoom
                labels.transition().attr("opacity", 0);
                svg.transition()
                    .duration(1200)
                    .tween("scale", function () {
                        let xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                            yd = d3.interpolate(y.domain(), [d.y0, 1]),
                            yr = d3.interpolate(y.range(), [d.y0 ? (80) : 0, radius]);
                        return function (t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); };
                    })
                    .selectAll("path")
                    .attrTween("d", function (d) { return function () { return arc(d); }; })
                  .each(function (e, i) {
                  // check if the animated element's data e lies within the visible angle span given in d
                  if (e.x0 >= d.x0 && e.x0 < (d.x0 + d.x1)) {
                      // get a selection of the associated text element
                    //   debugger
                      let arcText = d3.select(this.parentNode).select("text");
                      // fade in the text element and recalculate positions
                      arcText.transition().duration(1200)
                          .attr("opacity", 1)
                          .attr("transform", function () { return "translate(" + arc.centroid(d) + ")rotate(" + computeTextRotation(d) + ")"})
                        //   .attr("x", function (d) { return y(d.y); });
                    // labels.transition().duration(1200)
                    // .attr("opacity", 1)
                    // .attr("transform", function () { return "translate(" + arc.centroid(d) + ")rotate(" + computeTextRotation(d) + ")"})
                }
              })})
              .on("mouseover", function (d) {   //tooltip
                    div.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                        let leaf = '';
                        let percent = '';
                    if (d.parent && !d.parent.data.year) {
                        leaf = '<br/>' + d.parent.data.item;
                        percent = '<br/>' + (d.value / d.parent.value * 100).toFixed(2) + '%';
                    } else if (d.parent) {
                        percent = '<br/>' + (d.value / d.parent.value * 100).toFixed(2) + '%';
                    }
                    div.html(d.data[Object.keys(d.data)[0]] + leaf + '<br/>' + d.value + percent)
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY + 10) + "px")})
              .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0)})
              .on('mousemove', function (d) {                 
                    div.style('left', (d3.event.pageX + 10) + 'px')
                        .style('top', (d3.event.pageY + 10) + 'px');
                });
        });

        // labels as spokes
        function computeTextRotation(d) {
            let angle = x(d.x0 + d.x1) / Math.PI * 90;
            return (angle < 180) ? angle - 90 : angle + 90;
        }
    }

        draw()

        window.addEventListener("resize", draw);
    </script>
                                 
</html>