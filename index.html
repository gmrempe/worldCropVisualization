<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#000000" />

        <title>World Crop Production Visualization</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="FAOSTATData.json"></script>
        <script src="favicon-16x16.png"></script>

        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
            integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    </head>

    <style>
        @import url("https://fonts.googleapis.com/css?family=Montserrat");

        html body {
            height: 100%;
        }

        body {
            font-family: "Montserrat", "Helvetica Neue", Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            background-color: #f0f5f1;
        }

        nav {
            margin-top: auto;
            height: 50px;
            width: 100%;
            padding-top: 40px;
            display: flex;
            flex-direction: row;
            justify-content: center;
        }   

        .fab {
            color: #000;
            padding-right: 10px;
        }

        .fa-desktop {
            color: #000;
            padding-right: 7px;
        }

        .loading-container {
            position: absolute;
            z-index: -2;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .loading {
            z-index: -2;
            border: 16px solid #ebebeb;
            border-top: 16px solid #7c807d;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @-webkit-keyframes spin { 
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        div.tooltip {	
            position: absolute;			
            text-align: center;
            align-items: center;		
            min-width: 70px;					
            height: auto;					
            padding: 2px;				
            font: 12px sans-serif;		
            background: #fff;	
            border: 1px solid #000;		
            border-radius:5px;			
            pointer-events: none;			
        }

    </style>

    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div className="App">
            <header className="App-header" style="font-size: 35px; margin-left: 3%; margin-bottom: 25px;">
                World Crop Production
            </header>

            <p style="font-size: 15px; margin-left: 3%; margin-right: 3%;">This graph depicts one year of crop production on Earth. The center is 100% of crops in Tonnes, the inner ring shows the proportion of the total that each crop makes up and the outer ring shows which countries produce each crop. Click on a crop to zoom in for a better look at the countries that produce it. Click on the center to zoom out. Hover over a slice for more detailed information.</p>
            <label for='year' style="margin-left: 3%; margin-top: 10px">Select Year </label>
            
            <select className="year" id='year' onChange="draw()" style="padding: 5px;">
                    <option value="2017" selected>2017</option>
                    <option value="2010">2010</option>
                    <option value="2000">2000</option>
                    <option value="1990">1990</option>
                    <option value="1980">1980</option>
                    <option value="1970">1970</option>
                    <option value="1961">1961</option>
            </select>
            </br>
            <a style="font-size: 12px; margin-left: 3%; margin-top: 2px;" href="http://www.fao.org/faostat/en/#data/QC">Data from FAOSTAT</a>

        </div>

        <div class="loading-container">
            <div class="loading"></div>
        </div>

        <div id="chart" style="width: 750px; height: 750px;">
            <svg style="font-size: 11px;"></svg>
        </div>

        <footer class="nav-container">
            <nav>
                <a href="https://github.com/gmrempe">
                    <i class="fab fa-github fa-2x"></i>
                </a>
                <a href="https://www.linkedin.com/in/gregory-rempe-4372b3107/">
                    <i class="fab fa-linkedin-in fa-2x"></i>
                </a>
                <a href="http://gregory-rempe.com/">
                    <i class="fas fa-desktop fa-2x"></i>
                </a>
                <a href="https://angel.co/gregory-rempe-1">
                    <i class="fab fa-angellist fa-2x"></i>
                </a>
            </nav>
        </footer>


    </body>

    <script>
        function draw() {
            d3.selectAll('svg > *').remove();

            const year = document.getElementById('year').selectedOptions[0].value;
            const width = 750;
            const height = width;
            const radius = (width / 2);
            const x = d3.scaleLinear().range([0, 2 * Math.PI]);  //radians
            const y = d3.scalePow().range([0, radius]).exponent(0.8);
            let treeData = {};

            let div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            //grab data
            d3.json("FAOSTATData.json").then(function (data) {
                d3.selectAll('svg > *').remove();

                for(let i = 0; i < data.length; i++) {
                    if(data[i].year === year) {
                        treeData = data[i];
                    }
                }

                const color = function (d) {
                    //function adapted from Stephen Thomas
                    //http://bl.ocks.org/sathomas/4a3b74228d9cb11eb486
                    let colors;

                    if (!d.parent) {
                        colors = d3.scaleOrdinal(d3.schemeSet3)
                        d.color = "#f0f5f1";
                    } else if (d.children) {
                        let startColor = d3.hcl(d.color)
                                .darker(),
                            endColor = d3.hcl(d.color)
                                .brighter();

                        colors = d3.scaleLinear()
                            .interpolate(d3.interpolateHcl)
                            .range([
                                startColor.toString(),
                                endColor.toString()
                            ])
                            .domain([0, d.children.length + 1]);
                    }

                    if (d.children) {
                        d.children.map(function (child, i) {
                            return { value: child.value, idx: i };
                        }).sort(function (a, b) {
                            return b.value - a.value
                        }).forEach(function (child, i) {
                            d.children[child.idx].color = colors(i);
                        });
                    }

                    return d.color;
                };
                
                //place chart in center of svg element
                let svg = d3.select('svg')
                    .attr("viewBox", [0,0,width,width])
                .append('g')
                    .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');
                
                //give every node a value and sort
                const root = d3.hierarchy(treeData)
                    .sum(function(d) { return d.value})
                    .sort((a, b) => b.value - a.value)
                    
                //add x0, y0, x1, y1 onto each node
                const partitionLayout = d3.partition()
                
                partitionLayout(root);
                    
                const arc = d3.arc()
                    .startAngle( d => Math.max(0, Math.min(2 * Math.PI, x(d.x0))))
                    .endAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x1))))
                    .innerRadius(d => Math.max(0, y(d.y0)))
                    .outerRadius(d => Math.max(0, y(d.y1)));

                //make every node a g element
                let g = svg.selectAll('g')
                    .data(root.descendants())
                .enter().append('g')
                let path = g.append('path')
                    .attr("d", arc)
                    .style('stroke', '#f0f5f1')
                    .style("fill", color)

                let labels = g.append("text")
                    .attr("transform", function (d) {
                        return "translate(" + arc.centroid(d) + ")rotate(" + computeTextRotation(d) + ")";
                    })
                    .attr("pointer-events", "none")
                    .attr("text-anchor", "middle")
                    .attr("dy", ".35em")
                    .style("opacity", 0)
                    .text(function (d) { 
                        let text = d.data[Object.keys(d.data)[0]];
                        if (d.x1 - d.x0 >= 0.007) {
                            d3.select(this)
                                .style("opacity", 1)
                            return d.parent? text : '';
                        }
                        return text;
                    })

                path.on("click", function (d) {       //zoom
                labels.transition().style("opacity", 0);
                svg.transition()
                    .duration(1200)
                    .tween("scale", function () {
                        let xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                            yd = d3.interpolate(y.domain(), [d.y0, 1]),
                            yr = d3.interpolate(y.range(), [d.y0 ? (80) : 0, radius]);
                        return function (t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); };
                    })
                    .selectAll("path")
                    .attrTween("d", function (d) { return function () { return arc(d); }; })
                    .on("end", function (e) {
                    // check if labels are in selected wedge
                    if ((e.x0 >= d.x0) && e.x1 <= d.x1) {
                    let label = d3.select(this.parentNode).select("text");
                    // bring labels in and recalculate positions
                    if (e.x1 - e.x0 > ((d.x1 - d.x0) * .006)) {
                        label.transition()
                        .style("opacity", 1).duration(1200)
                        .attr("transform", function () { return "translate(" + arc.centroid(e) + ")rotate(" + computeTextRotation(e, d) + ")"})
                    }
                }
                })})
                .on("mouseover", function (d) {   //tooltip
                    div.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                        let leaf = '';
                        let percent = '';
                        let value = '';
                    if (d.parent && !d.parent.data.year) {
                        leaf = '<br/>' + d.parent.data.item;
                        percent = '<br/>' + (d.value / d.parent.value * 100).toFixed(2) + '% of Production';
                    } else if (d.parent) {
                        percent = '<br/>' + (d.value / d.parent.value * 100).toFixed(2) + '% of Production';
                    } else {
                        percent = '<br/> Total Production';
                    }
                    div.html(d.data[Object.keys(d.data)[0]] + leaf + '<br/>' + adjustLargeNumbers(d.value) + percent)
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY + 10) + "px")})
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0)})
                .on('mousemove', function (d) {                 
                    div.style('left', (d3.event.pageX + 10) + 'px')
                        .style('top', (d3.event.pageY + 10) + 'px');
                });

            });

            // calculate angle then adjust to spoke
            function computeTextRotation(d, e) {
                if (e === undefined) e = {x0 : 0};
                let angle = x(d.x0 + d.x1 - e.x0) / Math.PI * 90;
                return (angle < 180) ? angle - 90 : angle + 90;
            }

            function adjustLargeNumbers(num) {
                let n = String(num);
                let result;
                let adjusted;
                if(n.length > 9) {
                    adjusted = n / 1000000000;
                    result = `${adjusted.toFixed(2)} Billion Tonnes`;
                } else if (n.length > 6) {
                    adjusted = n / 1000000;
                    result = `${adjusted.toFixed(2)} Million Tonnes`;
                } else if (n.length > 3) {
                    adjusted = n / 1000;
                    result = `${adjusted.toFixed(2)} Thousand Tonnes`;
                } else {
                    result = `${n} Tonnes`;
                }
                return result;
            }
        }

        draw();

        window.addEventListener("resize", draw);
        //zoomable sunburst inspired by Mike Bostok
    </script>
                                 
</html>